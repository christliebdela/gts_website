<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Dashboard - GTS TRAILERS AFRICA LTD</title>
    
    <!-- Favicon -->
    <link rel="icon" href="../images/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Roboto', sans-serif;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        .card-header {
            background: linear-gradient(135deg, #1a4b84, #2a6eb8);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 16px 20px;
        }
        .admin-header {
            background: linear-gradient(135deg, #1a4b84, #2a6eb8);
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .admin-header h1 {
            font-size: 1.8rem;
            margin: 0;
        }
        .submission-card {
            transition: transform 0.2s;
            height: 100%;
        }
        .submission-card:hover {
            transform: translateY(-5px);
        }
        .submission-date {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #495057;
            font-weight: 500;
            padding: 12px 20px;
        }
        .nav-tabs .nav-link.active {
            color: #1a4b84;
            background-color: transparent;
            border-bottom: 3px solid #1a4b84;
        }
        .tab-content {
            padding-top: 20px;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .filters {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-badge {
            cursor: pointer;
            user-select: none;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        .empty-state i {
            font-size: 3rem;
            color: #dee2e6;
            margin-bottom: 15px;
        }
        .sort-icon {
            cursor: pointer;
            margin-left: 5px;
        }
        #logoutBtn {
            transition: all 0.3s;
        }
        #logoutBtn:hover {
            background-color: #dc3545;
            color: white;
        }
        .submission-actions {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="d-flex justify-content-center align-items-center" style="height: 100vh;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading admin panel...</span>
      </div>
    </div>

    <!-- Login Panel -->
    <div id="login-panel" style="display: none;">
        <div class="container login-container">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-lock me-2"></i>GTS Trailers Admin</h4>
                </div>
                <div class="card-body p-4">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                <input type="password" class="form-control" id="password" required>
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                        <div id="loginMessage" class="mt-3" style="display: none;"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" style="display: none;">
        <!-- Admin Header -->
        <div class="admin-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <h1><i class="fas fa-tachometer-alt me-2"></i>GTS Trailers Dashboard</h1>
                    <button id="logoutBtn" class="btn btn-light">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
        
        <div class="container pb-5">
            <!-- Tabs and Filters -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <ul class="nav nav-tabs" id="submissionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button" role="tab" aria-controls="contacts" aria-selected="true">
                                <i class="fas fa-envelope me-2"></i>Contact Messages
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="quotes-tab" data-bs-toggle="tab" data-bs-target="#quotes" type="button" role="tab" aria-controls="quotes" aria-selected="false">
                                <i class="fas fa-file-invoice-dollar me-2"></i>Quote Requests
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="col-lg-6">
                    <div class="search-container mt-3 mt-lg-0">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, or content...">
                            <button class="btn btn-outline-primary" type="button" id="searchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="submissionTabContent">
                <!-- Contact Submissions Tab -->
                <div class="tab-pane fade show active" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="filters">
                            <span class="badge bg-primary filter-badge active" data-filter="all">All</span>
                            <span class="badge bg-secondary filter-badge" data-filter="unread">Unread</span>
                            <span class="badge bg-success filter-badge" data-filter="responded">Responded</span>
                        </div>
                        <div class="sort-options">
                            <span class="sort-label me-2">Sort by:</span>
                            <span class="sort-option active" data-sort="newest">
                                Newest <i class="fas fa-sort-down"></i>
                            </span>
                            <span class="sort-option ms-3" data-sort="oldest">
                                Oldest <i class="fas fa-sort-up"></i>
                            </span>
                        </div>
                    </div>
                    
                    <div id="contactsList" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
                        <!-- Submissions will be inserted here -->
                        <div class="col-12 d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quote Requests Tab -->
                <div class="tab-pane fade" id="quotes" role="tabpanel" aria-labelledby="quotes-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="filters">
                            <span class="badge bg-primary filter-badge active" data-filter="all">All</span>
                            <span class="badge bg-secondary filter-badge" data-filter="pending">Pending</span>
                            <span class="badge bg-success filter-badge" data-filter="quoted">Quoted</span>
                        </div>
                        <div class="sort-options">
                            <span class="sort-label me-2">Sort by:</span>
                            <span class="sort-option active" data-sort="newest">
                                Newest <i class="fas fa-sort-down"></i>
                            </span>
                            <span class="sort-option ms-3" data-sort="oldest">
                                Oldest <i class="fas fa-sort-up"></i>
                            </span>
                        </div>
                    </div>
                    
                    <div id="quotesList" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
                        <!-- Submissions will be inserted here -->
                        <div class="col-12 d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Admin Panel JavaScript -->
    <script>
        console.log("Admin script starting");
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('loading-indicator').innerHTML = `
                <div class="alert alert-danger">
                    <h4>Error Loading Admin Panel</h4>
                    <p>${msg}</p>
                    <p>Line: ${line}</p>
                    <button class="btn btn-primary mt-2" onclick="showLoginPanelOnError()">Show Login Form</button>
                </div>
            `;
            console.error("Error caught:", error);
            return true;
        };

        function showLoginPanelOnError() {
            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('login-panel').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Supabase initialization using the client file
            // Declare supabaseClient in the outer scope so all functions can access it
            let supabaseClient;

            // Supabase initialization
            try {
                console.log("Initializing Supabase...");
                const SUPABASE_URL = 'https://khvbciywajadppmrvxxi.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtodmJjaXl3YWphZHBwbXJ2eHhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNzUwMjgsImV4cCI6MjA3MDg1MTAyOH0.bNbQt-z4_3FvuFfSw0Pvj2DGu9Lf6HeB8BZU_VkvgkY';

                if (!window.supabase) {
                    throw new Error("Supabase JS library not loaded. Check that the script tag is present and loading correctly.");
                }

                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase initialized successfully");
            } catch (err) {
                console.error("Failed to initialize Supabase:", err);
                document.getElementById('loading-indicator').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Supabase Initialization Error</h4>
                        <p>${err.message}</p>
                        <button class="btn btn-primary mt-2" onclick="showLoginPanelOnError()">Show Login Form</button>
                    </div>
                `;
            }
            
            // DOM Elements
            const loginPanel = document.getElementById('login-panel');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('loginForm');
            const loginMessage = document.getElementById('loginMessage');
            const logoutBtn = document.getElementById('logoutBtn');
            const contactsList = document.getElementById('contactsList');
            const quotesList = document.getElementById('quotesList');
            const togglePasswordBtn = document.getElementById('togglePassword');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            // Show password toggle
            togglePasswordBtn.addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });

            // Login form submission
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const submitBtn = loginForm.querySelector('button[type="submit"]');
                
                try {
                    // Show loading state
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Logging in...';
                    submitBtn.disabled = true;
                    
                    // Attempt to sign in
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    
                    // Show admin panel on successful login
                    showAdminPanel();
                    fetchSubmissions();
                    
                } catch (error) {
                    console.error('Error signing in:', error);
                    loginMessage.innerHTML = `<div class="alert alert-danger">${error.message || 'Failed to login. Please check your credentials.'}</div>`;
                    loginMessage.style.display = 'block';
                } finally {
                    submitBtn.innerHTML = 'Login';
                    submitBtn.disabled = false;
                }
            });
            
            // Logout button
            logoutBtn.addEventListener('click', async function() {
                try {
                    await supabaseClient.auth.signOut();
                    showLoginPanel();
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            });
            
            // Check if user is already signed in
            async function checkAuthStatus() {
                try {
                    console.log("Checking auth status...");
                    const { data, error } = await supabaseClient.auth.getSession();
                    
                    if (error) {
                        console.error("Auth error:", error);
                        throw error;
                    }
                    
                    console.log("Auth data:", data);
                    
                    if (data && data.session) {
                        showAdminPanel();
                        fetchSubmissions();
                    } else {
                        showLoginPanel();
                    }
                } catch (err) {
                    console.error("Authentication check failed:", err);
                    showLoginPanel(); // Fall back to login form
                }
            }
            
            // Show login panel
            function showLoginPanel() {
                loginPanel.style.display = 'block';
                adminPanel.style.display = 'none';
                loadingIndicator.style.display = 'none'; // Hide loading indicator
            }
            
            // Show admin panel
            function showAdminPanel() {
                loginPanel.style.display = 'none';
                adminPanel.style.display = 'block';
                loadingIndicator.style.display = 'none'; // Hide loading indicator
            }
            
            // Fetch submissions from Supabase
            async function fetchSubmissions() {
                try {
                    // Fetch contact submissions
                    const { data: contacts, error: contactsError } = await supabaseClient
                        .from('contact_submissions')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (contactsError) throw contactsError;
                    displayContacts(contacts || []);
                    
                    // Fetch quote requests
                    const { data: quotes, error: quotesError } = await supabaseClient
                        .from('quote_requests')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (quotesError) throw quotesError;
                    displayQuotes(quotes || []);
                    
                } catch (error) {
                    console.error('Error fetching submissions:', error);
                    contactsList.innerHTML = `<div class="col-12"><div class="alert alert-danger">Error loading submissions: ${error.message}</div></div>`;
                    quotesList.innerHTML = `<div class="col-12"><div class="alert alert-danger">Error loading submissions: ${error.message}</div></div>`;
                }
            }
            
            // Display contact submissions
            function displayContacts(contacts) {
                if (contacts.length === 0) {
                    contactsList.innerHTML = `
                        <div class="col-12 empty-state">
                            <i class="fas fa-envelope-open"></i>
                            <h4>No contact submissions yet</h4>
                            <p class="text-muted">When visitors submit the contact form, their messages will appear here.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                contacts.forEach(contact => {
                    const date = new Date(contact.created_at).toLocaleString();
                    const status = contact.status || 'unread'; // Default to unread if not set
                    const statusBadge = status === 'unread' ? 
                        '<span class="badge bg-secondary">Unread</span>' : 
                        '<span class="badge bg-success">Responded</span>';
                    
                    html += `
                        <div class="col" data-id="${contact.id}" data-status="${status}">
                            <div class="card submission-card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${escapeHtml(contact.name)}</h5>
                                    ${statusBadge}
                                </div>
                                <div class="card-body">
                                    <p class="card-text submission-date"><i class="far fa-clock me-1"></i>${date}</p>
                                    <p class="card-text"><strong>Email:</strong> <a href="mailto:${escapeHtml(contact.email)}">${escapeHtml(contact.email)}</a></p>
                                    <p class="card-text"><strong>Phone:</strong> <a href="tel:${escapeHtml(contact.phone)}">${escapeHtml(contact.phone)}</a></p>
                                    ${contact.company ? `<p class="card-text"><strong>Company:</strong> ${escapeHtml(contact.company)}</p>` : ''}
                                    <p class="card-text"><strong>Message:</strong></p>
                                    <p class="card-text">${escapeHtml(contact.message)}</p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="submission-actions">
                                        <a href="mailto:${escapeHtml(contact.email)}?subject=Re: Your inquiry to GTS Trailers Africa&body=Dear ${escapeHtml(contact.name)},%0D%0A%0D%0AThank you for contacting GTS TRAILERS AFRICA LTD.%0D%0A%0D%0ARegarding your inquiry:%0D%0A%0D%0A${escapeHtml(contact.message.substring(0, 100))}...%0D%0A%0D%0ABest regards,%0D%0AGTS TRAILERS AFRICA Team" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-reply me-1"></i>Reply
                                        </a>
                                        <button class="btn btn-sm btn-outline-success mark-responded" data-id="${contact.id}" ${status !== 'unread' ? 'disabled' : ''}>
                                            <i class="fas fa-check me-1"></i>Mark Responded
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                contactsList.innerHTML = html;
                
                // Add event listeners to mark-responded buttons
                document.querySelectorAll('.mark-responded').forEach(button => {
                    button.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        try {
                            const { error } = await supabaseClient
                                .from('contact_submissions')
                                .update({ status: 'responded' })
                                .eq('id', id);
                            
                            if (error) throw error;
                            
                            // Update UI
                            const card = this.closest('.col');
                            card.setAttribute('data-status', 'responded');
                            card.querySelector('.badge').className = 'badge bg-success';
                            card.querySelector('.badge').textContent = 'Responded';
                            this.disabled = true;
                            
                        } catch (error) {
                            console.error('Error updating status:', error);
                            alert('Failed to update status. Please try again.');
                        }
                    });
                });
            }
            
            // Display quote requests
            function displayQuotes(quotes) {
                if (quotes.length === 0) {
                    quotesList.innerHTML = `
                        <div class="col-12 empty-state">
                            <i class="fas fa-file-invoice"></i>
                            <h4>No quote requests yet</h4>
                            <p class="text-muted">When customers request quotes, they will appear here.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                quotes.forEach(quote => {
                    const date = new Date(quote.created_at).toLocaleString();
                    const status = quote.status || 'pending'; // Default to pending if not set
                    const statusBadge = status === 'pending' ? 
                        '<span class="badge bg-secondary">Pending</span>' : 
                        '<span class="badge bg-success">Quoted</span>';
                    
                    html += `
                        <div class="col" data-id="${quote.id}" data-status="${status}">
                            <div class="card submission-card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${escapeHtml(quote.name)}</h5>
                                    ${statusBadge}
                                </div>
                                <div class="card-body">
                                    <p class="card-text submission-date"><i class="far fa-clock me-1"></i>${date}</p>
                                    <p class="card-text"><strong>Email:</strong> <a href="mailto:${escapeHtml(quote.email)}">${escapeHtml(quote.email)}</a></p>
                                    <p class="card-text"><strong>Phone:</strong> <a href="tel:${escapeHtml(quote.phone)}">${escapeHtml(quote.phone)}</a></p>
                                    ${quote.company ? `<p class="card-text"><strong>Company:</strong> ${escapeHtml(quote.company)}</p>` : ''}
                                    <p class="card-text"><strong>Product:</strong> ${escapeHtml(quote.product_type)}</p>
                                    <p class="card-text"><strong>Requirements:</strong></p>
                                    <p class="card-text">${escapeHtml(quote.message)}</p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="submission-actions">
                                        <a href="mailto:${escapeHtml(quote.email)}?subject=Your Quote Request for ${escapeHtml(quote.product_type)}&body=Dear ${escapeHtml(quote.name)},%0D%0A%0D%0AThank you for your interest in GTS TRAILERS AFRICA LTD products.%0D%0A%0D%0ARegarding your quote request for ${escapeHtml(quote.product_type)}:%0D%0A%0D%0A${escapeHtml(quote.message.substring(0, 100))}...%0D%0A%0D%0ABest regards,%0D%0AGTS TRAILERS AFRICA Team" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-reply me-1"></i>Send Quote
                                        </a>
                                        <button class="btn btn-sm btn-outline-success mark-quoted" data-id="${quote.id}" ${status !== 'pending' ? 'disabled' : ''}>
                                            <i class="fas fa-check me-1"></i>Mark Quoted
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                quotesList.innerHTML = html;
                
                // Add event listeners to mark-quoted buttons
                document.querySelectorAll('.mark-quoted').forEach(button => {
                    button.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        try {
                            const { error } = await supabaseClient
                                .from('quote_requests')
                                .update({ status: 'quoted' })
                                .eq('id', id);
                            
                            if (error) throw error;
                            
                            // Update UI
                            const card = this.closest('.col');
                            card.setAttribute('data-status', 'quoted');
                            card.querySelector('.badge').className = 'badge bg-success';
                            card.querySelector('.badge').textContent = 'Quoted';
                            this.disabled = true;
                            
                        } catch (error) {
                            console.error('Error updating status:', error);
                            alert('Failed to update status. Please try again.');
                        }
                    });
                });
            }
            
            // Filter functionality
            document.querySelectorAll('.filter-badge').forEach(badge => {
                badge.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    const tabId = document.querySelector('.tab-pane.active').id;
                    
                    if (tabId === 'contacts') {
                        filterContacts(filter);
                    } else if (tabId === 'quotes') {
                        filterQuotes(filter);
                    }
                });
            });
            
            // Filter contacts
            function filterContacts(filter) {
                const items = document.querySelectorAll('#contactsList .col');
                
                items.forEach(item => {
                    if (filter === 'all' || item.getAttribute('data-status') === filter) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Show empty state if no visible items
                let visibleCount = 0;
                items.forEach(item => {
                    if (item.style.display !== 'none') visibleCount++;
                });
                
                if (visibleCount === 0) {
                    const emptyState = `
                        <div class="col-12 empty-state">
                            <i class="fas fa-filter"></i>
                            <h4>No matching submissions</h4>
                            <p class="text-muted">No contact submissions match your current filter.</p>
                        </div>
                    `;
                    
                    // Insert empty state if it doesn't exist
                    if (!document.querySelector('#contactsList .empty-state')) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = emptyState;
                        contactsList.appendChild(tempDiv.firstElementChild);
                    }
                } else {
                    // Remove empty state if it exists
                    const emptyState = document.querySelector('#contactsList .empty-state');
                    if (emptyState) emptyState.remove();
                }
            }
            
            // Filter quotes
            function filterQuotes(filter) {
                const items = document.querySelectorAll('#quotesList .col');
                
                items.forEach(item => {
                    if (filter === 'all' || item.getAttribute('data-status') === filter) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Show empty state if no visible items
                let visibleCount = 0;
                items.forEach(item => {
                    if (item.style.display !== 'none') visibleCount++;
                });
                
                if (visibleCount === 0) {
                    const emptyState = `
                        <div class="col-12 empty-state">
                            <i class="fas fa-filter"></i>
                            <h4>No matching requests</h4>
                            <p class="text-muted">No quote requests match your current filter.</p>
                        </div>
                    `;
                    
                    // Insert empty state if it doesn't exist
                    if (!document.querySelector('#quotesList .empty-state')) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = emptyState;
                        quotesList.appendChild(tempDiv.firstElementChild);
                    }
                } else {
                    // Remove empty state if it exists
                    const emptyState = document.querySelector('#quotesList .empty-state');
                    if (emptyState) emptyState.remove();
                }
            }
            
            // Search functionality
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            function performSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const tabId = document.querySelector('.tab-pane.active').id;
                
                if (tabId === 'contacts') {
                    searchContacts(searchTerm);
                } else if (tabId === 'quotes') {
                    searchQuotes(searchTerm);
                }
            }
            
            function searchContacts(searchTerm) {
                const items = document.querySelectorAll('#contactsList .col');
                
                if (!searchTerm) {
                    // If search is cleared, respect the current filter
                    const currentFilter = document.querySelector('#contacts .filter-badge.active').getAttribute('data-filter');
                    filterContacts(currentFilter);
                    return;
                }
                
                let matchFound = false;
                
                items.forEach(item => {
                    const name = item.querySelector('.card-header h5').textContent.toLowerCase();
                    const email = item.querySelector('a[href^="mailto:"]').textContent.toLowerCase();
                    const message = item.querySelector('p:last-child').textContent.toLowerCase();
                    const company = item.querySelector('p:nth-child(4)') ? 
                        item.querySelector('p:nth-child(4)').textContent.toLowerCase() : '';
                    
                    if (name.includes(searchTerm) || 
                        email.includes(searchTerm) || 
                        message.includes(searchTerm) || 
                        company.includes(searchTerm)) {
                        item.style.display = '';
                        matchFound = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Show no results message if needed
                if (!matchFound) {
                    const emptyState = `
                        <div class="col-12 empty-state">
                            <i class="fas fa-search"></i>
                            <h4>No matching results</h4>
                            <p class="text-muted">No contact submissions match your search term "${searchTerm}".</p>
                        </div>
                    `;
                    
                    // Insert empty state if it doesn't exist
                    if (!document.querySelector('#contactsList .empty-state')) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = emptyState;
                        contactsList.appendChild(tempDiv.firstElementChild);
                    }
                } else {
                    // Remove empty state if it exists
                    const emptyState = document.querySelector('#contactsList .empty-state');
                    if (emptyState) emptyState.remove();
                }
            }
            
            function searchQuotes(searchTerm) {
                const items = document.querySelectorAll('#quotesList .col');
                
                if (!searchTerm) {
                    // If search is cleared, respect the current filter
                    const currentFilter = document.querySelector('#quotes .filter-badge.active').getAttribute('data-filter');
                    filterQuotes(currentFilter);
                    return;
                }
                
                let matchFound = false;
                
                items.forEach(item => {
                    const name = item.querySelector('.card-header h5').textContent.toLowerCase();
                    const email = item.querySelector('a[href^="mailto:"]').textContent.toLowerCase();
                    const message = item.querySelector('p:last-child').textContent.toLowerCase();
                    const product = item.querySelector('p:nth-child(5)').textContent.toLowerCase();
                    const company = item.querySelector('p:nth-child(4)') ? 
                        item.querySelector('p:nth-child(4)').textContent.toLowerCase() : '';
                    
                    if (name.includes(searchTerm) || 
                        email.includes(searchTerm) || 
                        message.includes(searchTerm) || 
                        product.includes(searchTerm) || 
                        company.includes(searchTerm)) {
                        item.style.display = '';
                        matchFound = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Show no results message if needed
                if (!matchFound) {
                    const emptyState = `
                        <div class="col-12 empty-state">
                            <i class="fas fa-search"></i>
                            <h4>No matching results</h4>
                            <p class="text-muted">No quote requests match your search term "${searchTerm}".</p>
                        </div>
                    `;
                    
                    // Insert empty state if it doesn't exist
                    if (!document.querySelector('#quotesList .empty-state')) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = emptyState;
                        quotesList.appendChild(tempDiv.firstElementChild);
                    }
                } else {
                    // Remove empty state if it exists
                    const emptyState = document.querySelector('#quotesList .empty-state');
                    if (emptyState) emptyState.remove();
                }
            }
            
            // Sort functionality
            document.querySelectorAll('.sort-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Update active state
                    document.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    
                    const sort = this.getAttribute('data-sort');
                    const tabId = document.querySelector('.tab-pane.active').id;
                    
                    if (tabId === 'contacts') {
                        sortContacts(sort);
                    } else if (tabId === 'quotes') {
                        sortQuotes(sort);
                    }
                });
            });
            
            function sortContacts(sort) {
                const items = Array.from(document.querySelectorAll('#contactsList .col'));
                const container = document.getElementById('contactsList');
                
                items.sort((a, b) => {
                    const dateA = new Date(a.querySelector('.submission-date').textContent.replace('i class="far fa-clock me-1"></i>', ''));
                    const dateB = new Date(b.querySelector('.submission-date').textContent.replace('i class="far fa-clock me-1"></i>', ''));
                    
                    return sort === 'newest' ? dateB - dateA : dateA - dateB;
                });
                
                // Remove all items
                items.forEach(item => item.remove());
                
                // Add sorted items
                items.forEach(item => container.appendChild(item));
            }
            
            function sortQuotes(sort) {
                const items = Array.from(document.querySelectorAll('#quotesList .col'));
                const container = document.getElementById('quotesList');
                
                items.sort((a, b) => {
                    const dateA = new Date(a.querySelector('.submission-date').textContent.replace('i class="far fa-clock me-1"></i>', ''));
                    const dateB = new Date(b.querySelector('.submission-date').textContent.replace('i class="far fa-clock me-1"></i>', ''));
                    
                    return sort === 'newest' ? dateB - dateA : dateA - dateB;
                });
                
                // Remove all items
                items.forEach(item => item.remove());
                
                // Add sorted items
                items.forEach(item => container.appendChild(item));
            }
            
            // Tab change handlers
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function() {
                    // Reset search when switching tabs
                    searchInput.value = '';
                    
                    // Reset filters when switching tabs
                    document.querySelectorAll('.filter-badge').forEach(badge => {
                        badge.classList.remove('active');
                    });
                    
                    // Set "All" filter as active
                    document.querySelectorAll('.filter-badge[data-filter="all"]').forEach(badge => {
                        badge.classList.add('active');
                    });
                });
            });
            
            // Utility function to escape HTML
            function escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
            
            // Initialize the admin panel
            checkAuthStatus();
        });
        
        // Add this near the end of your script before checkAuthStatus() is called
        setTimeout(() => {
            // If still showing loading after 5 seconds, show login form
            if (document.getElementById('loading-indicator').style.display !== 'none') {
                console.log("Timeout reached, forcing login form display");
                showLoginPanel();
            }
        }, 5000);
    </script>
</body>
</html>